---
params: 
    set_title: "Appendix A"
title: "`r params$set_title`"
author: "Sorenson Impact Center Data Science Team"
mainfont: Roboto
output:
  word_document:
      
    reference_docx: template/mystyles.docx
    fig_width: 6
    fig_height: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Load packages 

library(siverse)
library(tidyverse)
library(tidycensus)
library(tigris)
library(scales)
library(gridExtra)
library(RColorBrewer)

theme_set(theme_minimal())
theme_update(text = element_text(family = "Roboto"), axis.text = element_text(family = "Roboto"), strip.text = element_text(family = "Roboto"), axis.text.x = element_text(angle = 45, hjust = 1))
options(scipen = 100)

si_knitr_settings()

```

<br>

`r include_graphics(path.expand("./template/SI_logo.png"))`

<br>

`r include_graphics(path.expand("./template/earth_map.jpeg"))`


#### A report prepared by the Sorenson Impact Center Data Science Team.



##### Pagebreak

```{r data, message=FALSE, warning=FALSE, include=FALSE}

datapath <- path_expand("G:/My Drive/SI/Current Projects/CRA Needs Assessment/WS 2_Analysis of Publicly Available Data/Data/")

wic <- read.csv("G:/My Drive/SI/Current Projects/CRA Needs Assessment/WS 2_Analysis of Publicly Available Data/Data/WIC_Clinics_in_Utah.csv") %>% clean_names()

poverty <- read.csv(path(datapath,"Poverty_data_by_Age__City_and_County_Utah_2013.csv")) %>% clean_names()

education <- read.csv(path(datapath, "Utah_Educational_Level_By_Census_Tract_2013.csv")) %>% clean_names()

hud <- read.csv(path(datapath, "County_HUD_Data_Utah_2011.csv")) %>% clean_names()

homelessness <- read.csv(path(datapath, "ut_homelessness.csv")) 

var <- load_variables(2017, "acs1", cache = TRUE) #List variables for ACS 1 year

var5 <- load_variables(2016,"acs5", cache =TRUE)


edu_above_25 <- education %>% 
  select(1, 38,44,50,56,62,68,74)

edu_18_to_24 <- education %>% 
  select(1,8,14,20,26) 

pov_county <- poverty %>% 
  mutate(county1 = str_replace_all(county, '[ \t]+$', "")) %>% 
  mutate(county1 = case_when(county1 == "San Juabn"~"San Juan",
                             TRUE~county1))

pov_city <- poverty %>% 
  separate(location_1, c("city1","geo"), sep = "\\(", remove = FALSE) %>% 
  separate(city1, c("city","state"), sep="\\,", remove = FALSE ) %>% 
  select(-city1)

hud <- hud %>% 
  mutate(program_label = factor(program_label, ordered = TRUE,
                                 levels = c("Summary of All HUD Programs", "Housing Choice Vouchers",
                                            "LIHTC","Mod Rehab", "Multi-Family Other","Public Housing",
                                            "Section 236","Section 8 NC/SR")))

```




```{r education 18_24, echo=FALSE, message=FALSE, warning=FALSE}

edu_18_to_24%>% 
  separate(geography, c("census_tract", "county"), sep = "\\,", remove = FALSE) %>% 
  select(county, 4:7) %>% 
  group_by(county) %>% 
  filter(county == " Davis County"|
           county == " Salt Lake County"|
           county == " Summit County"|
           county == " Tooele County"|
           county == " Utah County"|
           county == " Weber County") %>% 
  group_by(county) %>% 
  summarise_if(is.numeric, mean,na.rm  = TRUE) %>% 
  gather("education_lvl", "pct_estimate", 2:5) %>% 
  mutate(education_lvl = factor(education_lvl, ordered = TRUE, 
                                levels = c("total_estimate_less_than_high_school_graduate",
                                           "total_estimate_high_school_graduate_includes_equivalency",
                                           "total_estimate_some_college_or_associate_s_degree",
                                           "total_estimate_bachelor_s_degree_or_higher"))) %>% 
  ggplot(aes(x = county, y = pct_estimate, fill = education_lvl))+
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Percent Distribution of Education (among 18-24 year-olds) by County", x = "County", y = " Percent")+
  scale_fill_brewer(name ="", 
                    palette = "YlOrRd",
                    breaks = c("total_estimate_less_than_high_school_graduate",
                                           "total_estimate_high_school_graduate_includes_equivalency",
                                           "total_estimate_some_college_or_associate_s_degree",
                                           "total_estimate_bachelor_s_degree_or_higher"),
                      labels = c("Less Than High School",
                                 "High School Graduate",
                                 "Some College or Associate's Degree",
                                 "Bachelor's Degree of Higher"))

```



```{r education above 25, echo=FALSE, message=FALSE, warning=FALSE}

edu_above_25 %>% 
  separate(geography, c("census_tract", "county"), sep = "\\,", remove = FALSE) %>% 
  select(county, 4:10) %>% 
  group_by(county) %>% 
  filter(county == " Davis County"|
           county == " Salt Lake County"|
           county == " Summit County"|
           county == " Tooele County"|
           county == " Utah County"|
           county == " Weber County") %>% 
  mutate(total_estimate_less_than_high_school_graduate = total_estimate_population_25_years_and_over_less_than_9th_grade+total_estimate_population_25_years_and_over_9th_to_12th_grade_no_diploma,
         total_estimate_some_college_or_associate_s_degree = total_estimate_population_25_years_and_over_some_college_no_degree+total_estimate_population_25_years_and_over_associate_s_degree) %>% 
  select(1, 9,4,10,7,8) %>% 
  group_by(county)%>% 
  summarise_if(is.numeric, mean,na.rm  = TRUE) %>% 
  gather("education_lvl", "pct_estimate", 2:6) %>% 
  mutate(education_lvl = factor(education_lvl, ordered = TRUE, 
                                levels = c("total_estimate_less_than_high_school_graduate",
                                           "total_estimate_population_25_years_and_over_high_school_graduate_includes_equivalency",
                                           "total_estimate_some_college_or_associate_s_degree",
                                           "total_estimate_population_25_years_and_over_bachelor_s_degree",
                                           "total_estimate_population_25_years_and_over_graduate_or_professional_degree"))) %>% 
  ggplot(aes(x = county, y = pct_estimate, fill = education_lvl))+
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Percent Distribution of Education (ages above 25) by County", x = "County", y = "Percent")+
  scale_fill_brewer(name ="", 
                    palette = "YlOrRd",
                    breaks = c("total_estimate_less_than_high_school_graduate",
                                           "total_estimate_population_25_years_and_over_high_school_graduate_includes_equivalency",
                                           "total_estimate_some_college_or_associate_s_degree",
                                           "total_estimate_population_25_years_and_over_bachelor_s_degree",
                               "total_estimate_population_25_years_and_over_graduate_or_professional_degree"),
                      labels = c("Less Than High School",
                                 "High School Graduate",
                                 "Some College or Associate's Degree",
                                 "Bachelor's Degree of Higher",
                                 "Graduate of Professional Degree"))
  

```





```{r wic, echo=FALSE, message=FALSE, warning=FALSE}

wic1 <- wic %>% separate(location_1, c("address","city1","geo"), sep = "\\n", remove = FALSE) %>% 
  separate(city1, c("city","state"), sep="\\,", remove = FALSE )

wic1 %>% 
  group_by(health_department) %>% 
  count() %>% 
  ggplot(aes(x = reorder(health_department,n), y= n , fill = n)) +
  geom_bar(stat = "identity")+
  labs(title = " Distribution of WIC Clinics in Utah",
       x = "WIC Clinic Locations", y = "Count")+
  scale_fill_gradient(low = "red", high = "darkred", guide = FALSE)+
  coord_flip()

```




```{r avg med inc county, echo=FALSE, message=FALSE, warning=FALSE}

pov_county %>% 
  group_by(county1) %>% 
  filter(county1 == "Davis"|
           county1 == "Salt Lake"| 
         county1 == "Summit"|
         county1=="Tooele"|
         county1 == "Utah"|
         county1 == "Weber") %>% 
  summarize(avg_median_income = mean(median_household_income, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(county1, -avg_median_income), y = avg_median_income, fill = factor(avg_median_income)))+
  geom_bar(stat = "identity")+
  labs(title = "Average Median Income by County", x = "County", y = "Average Median Income")+
  scale_y_continuous(labels = dollar)+ 
  scale_fill_brewer(palette = "Reds", guide = FALSE)

```



```{r avg gini index county, echo=FALSE, message=FALSE, warning=FALSE}

pov_county %>%  
  group_by(county1) %>%
  filter(county1 == "Davis"|
           county1 == "Salt Lake"| 
         county1 == "Summit"|
         county1=="Tooele"|
         county1 == "Utah"|
         county1 == "Weber") %>%
  summarize(avg_gini_index = mean(gini_index, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(county1, -avg_gini_index), y = avg_gini_index, fill = factor(avg_gini_index)))+
  geom_bar(stat = "identity")+
  labs(title = "Average Gini Index by County", x = "County", y = "Average Gini Index")+ 
  scale_fill_brewer(palette = "Reds", guide = FALSE)

```



```{r highest Gini cities, echo=FALSE, message=FALSE, warning=FALSE}

getPalette = colorRampPalette(brewer.pal(9, "Reds"))

pov_city %>% 
  arrange(desc(gini_index)) %>% 
  slice(1:10) %>% 
  ggplot(aes(x = reorder(city, -gini_index), y = gini_index, fill = factor(gini_index)))+
  geom_bar(stat = "identity")+
  labs(title = "Top 10 Cities with Highest Gini Index",
       x = "City", y = "Gini Index")+ 
  scale_fill_manual(values = getPalette(10), guide = FALSE)


```



```{r lowest Gini cities, echo=FALSE, message=FALSE, warning=FALSE}

pov_city %>% 
  arrange((gini_index)) %>% 
  slice(1:10) %>% 
  ggplot(aes(x = reorder(city, gini_index), y = gini_index, fill = factor(gini_index)))+
  geom_bar(stat = "identity")+
  labs(title = "Top 10 Cities with Lowest Gini Index",
       x = "City", y = "Gini Index")+ 
  scale_fill_manual(values = getPalette(10), guide = FALSE)


```




```{r pop below poverty level county, echo=FALSE, message=FALSE, warning=FALSE}

pov_county %>%  
  group_by(county1) %>% 
  filter(county1 == "Davis"|
           county1 == "Salt Lake"| 
         county1 == "Summit"|
         county1=="Tooele"|
         county1 == "Utah"|
         county1 == "Weber") %>%
  summarize(avg_below_poverty_level = mean(below_poverty_level, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(county1, -avg_below_poverty_level), y = avg_below_poverty_level, fill = factor(avg_below_poverty_level)))+
  geom_bar(stat = "identity")+
  labs(title = "Average Population Below Poverty Level by County", x = "County", y = "Average Population Below Poverty Level")+ 
  scale_fill_brewer(palette = "Reds", guide = FALSE)+
  scale_y_continuous(labels = comma)


```



```{r avg poverty rate county, echo=FALSE, message=FALSE, warning=FALSE}

pov_county %>% 
  mutate(total_pop = below_poverty_level+ at_or_above_poverty_level) %>% 
  group_by(county1) %>% 
  filter(county1 == "Davis"|
           county1 == "Salt Lake"| 
         county1 == "Summit"|
         county1=="Tooele"|
         county1 == "Utah"|
         county1 == "Weber") %>%
  summarise(tot_below_poverty = sum(below_poverty_level),
            tot_above_poverty = sum(at_or_above_poverty_level),
            agg_total_pop = sum(total_pop),
            poverty_rate = tot_below_poverty/agg_total_pop) %>% 
  ggplot(aes(x = reorder(county1, -poverty_rate), y = poverty_rate, fill = factor(poverty_rate)))+
  geom_bar(stat = "identity")+
  labs(title = "Average Poverty Rate by County", x = "County", y = "Average Poverty Rate")+ 
  scale_fill_brewer(palette = "Reds", guide = FALSE)

```

```{r pop below poverty level city, echo=FALSE, message=FALSE, warning=FALSE}

pov_city %>% 
  arrange(desc(below_poverty_level)) %>% 
  slice(1:10) %>% 
  ggplot(aes(x = reorder(city, -below_poverty_level), y = below_poverty_level, fill = factor(below_poverty_level)))+
  geom_bar(stat = "identity")+
  labs(title = "Top 10 Cities with Highest Populations Below Poverty Level",
       x = "City", y = "Population Below Poverty Level")+ 
  scale_fill_manual(values = getPalette(10), guide = FALSE)+
  scale_y_continuous(labels = comma)

```





```{r highest poverty rate, echo=FALSE, message=FALSE, warning=FALSE}

pov_city %>% 
  mutate(total_pop = below_poverty_level+ at_or_above_poverty_level,
         poverty_rate = below_poverty_level/total_pop) %>% 
  arrange(desc(poverty_rate)) %>% 
  slice(1:10) %>% 
  ggplot(aes(x = reorder(city, -poverty_rate), y = poverty_rate, fill = factor(poverty_rate)))+
  geom_bar(stat = "identity")+
  labs(title = "Top 10 Cities with highest poverty rates",
       x = "City", y = "Poverty rates")+ 
  scale_fill_manual(values = getPalette(10), guide = FALSE)


```




```{r poverty by sex,  echo=FALSE, message=FALSE, warning=FALSE}

pov_city %>% 
  mutate(total_pop = below_poverty_level+ at_or_above_poverty_level,
         poverty_rate = below_poverty_level/total_pop,
         total_below_poverty_males = (below_poverty_level_male+at_or_above_poverty_level_male)/total_pop,
         total_below_poverty_females = (below_poverty_level_female+at_or_above_poverty_level_female)/total_pop) %>%  
  arrange(desc(poverty_rate)) %>% 
  slice(1:10) %>% 
  select(city, total_below_poverty_males,total_below_poverty_females) %>% 
  rename(male = total_below_poverty_males,
         female = total_below_poverty_females) %>% 
  gather("sex","poverty_rates",2:3) %>% 
  ggplot(aes(x = city, y = poverty_rates, fill = sex))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Poverty Rates by Sex for the Top 10 Cities with the Highest Poverty Rates",
       x = "City", y = "Poverty Rate")+
  scale_fill_manual(values = c("#CF3721","#31a9b8"),
                    name = "Sex", 
                    labels = c("Female", "Male")) #(27.cheerfulbrights-color ref)

```




```{r hud total units, echo=FALSE, message=FALSE, warning=FALSE}

hud %>% 
  filter(name!="No county code", 
         total_units > quantile(total_units, 0.25, na.rm = T)) %>% 
  filter(name == "Davis County"|
           name == "Salt Lake County"|
           name == "Tooele County"|
           name == "Utah County"|
           name == "Weber County") %>% 
  ggplot(aes(x = reorder(name, -total_units), y = total_units, fill = total_units))+
  geom_bar(stat = "identity")+
  labs(title = "Total Number of Units by County and HUD Program",  
       x = "County", y = "Total Units")+
  facet_wrap(vars(program_label), scales = "free_y")+
  scale_fill_gradient(high = "#a50f15", low = "#fcbba1", guide = FALSE)+
  scale_y_continuous(labels = comma)


```




```{r hud pct occupied, echo=FALSE, message=FALSE, warning=FALSE}

hud %>% 
  filter(name!="No county code", 
         pct_occupied > 0) %>% 
  filter(name == "Davis County"|
           name == "Salt Lake County"|
           name == "Tooele County"|
           name == "Utah County"|
           name == "Weber County") %>% 
  ggplot(aes(x = reorder(name, -pct_occupied), y = pct_occupied, fill = pct_occupied))+
  geom_bar(stat = "identity")+
  labs(title = "Percent Occupied by County and HUD Program",  
       x = "County", y = "Percent Occupied")+
  facet_wrap(vars(program_label), scales = "free_y")+
  scale_fill_gradient(high = "#a50f15", low = "#fcbba1", guide = FALSE)

```


```{r hud rent pct, echo=FALSE, message=FALSE, warning=FALSE}

hud %>% 
  filter(rent_per_month>0,
         hh_income>0) %>%
  filter(name == "Davis County"|
           name == "Salt Lake County"|
           name == "Tooele County"|
           name == "Utah County"|
           name == "Weber County") %>% 
  mutate(rent_as_pct_income = rent_per_month/hh_income) %>% 
  ggplot(aes(x=reorder(name,-rent_as_pct_income), y = rent_as_pct_income, fill =rent_as_pct_income))+
  geom_bar(stat = "identity")+
  labs(title = "Rent as Percent of Income by County and Program", x = "County", y="Percentage")+
  facet_wrap(vars(program_label), scales = "free_y")+
  scale_fill_gradient(high = "#a50f15", low = "#fcbba1", guide = FALSE)+
  scale_y_continuous(labels = percent)

```



```{r hud months waiting, echo=FALSE, message=FALSE, warning=FALSE}

hud %>% 
  filter(months_waiting>0) %>%
  filter(name == "Davis County"|
           name == "Salt Lake County"|
           name == "Tooele County"|
           name == "Utah County"|
           name == "Weber County") %>% 
  ggplot(aes(x=reorder(name,-months_waiting), y = months_waiting, fill =months_waiting))+
  geom_bar(stat = "identity")+
  labs(title = "Months Waiting by County and Program", x = "County", y="Months")+
  facet_wrap(vars(program_label), scales = "free_y")+
  scale_fill_gradient(high = "#a50f15", low = "#fcbba1", guide = FALSE)
```

```{r months from move in, echo=FALSE, message=FALSE, warning=FALSE}

hud %>% 
  filter(months_from_movein>0) %>%
  filter(name == "Davis County"|
           name == "Salt Lake County"|
           name == "Tooele County"|
           name == "Utah County"|
           name == "Weber County") %>%
  ggplot(aes(x=reorder(name,-months_from_movein), y = months_from_movein, fill =months_from_movein))+
  geom_bar(stat = "identity")+
  labs(title = "Months from Move In by County and Program", x = "County", y="Months")+
  facet_wrap(vars(program_label), scales = "free_y")+
  scale_fill_gradient(high = "#a50f15", low = "#fcbba1", guide = FALSE)

```



```{r sheltered headcount, echo=FALSE, message=FALSE, warning=FALSE}

homelessness %>% 
  filter(category == "Sheltered Headcount", type == "Total") %>% 
  select(county, x2011, x2012, x2013, x2014) %>% 
  gather("years", "count", 2:5) %>% 
  mutate(years = case_when(years == "x2011"~"2011",
                           years == "x2012"~"2012",
                           years == "x2013"~"2013",
                           years == "x2014"~"2014"),
         years = as.numeric(years)) %>%
  ggplot(aes(x = years, y = count, color = county))+
  geom_line(size =1) +
  labs(title = "Sheltered homeless headcounts over time", 
       x = "Years", y = "Sheltered Homeless Headcount")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}

homelessness %>% 
  filter(category == "Unsheltered Headcount", type == "Total") %>% 
  select(county, x2011, x2012, x2013, x2014) %>% 
  gather("years", "count", 2:5) %>% 
  mutate(years = case_when(years == "x2011"~"2011",
                           years == "x2012"~"2012",
                           years == "x2013"~"2013",
                           years == "x2014"~"2014"),
         years = as.numeric(years)) %>%
  ggplot(aes(x = years, y = count, color = county))+
  geom_line(size =1) +
  labs(title = "Unsheltered homeless headcount over time", 
       x = "Years", y = "Unsheltered Homeless Headcount")+
  



homelessness %>% 
  filter(type =="Total",
         category == "Unsheltered Headcount"| category=="Sheltered Headcount") %>% 
  print()


  

```



```{r echo=FALSE, message=FALSE, warning=FALSE}

emp_tot <- map_df(2012:2017, function(x){
  get_acs(geography = "county",
          variables = c(tot = "B23025_001"),
          state = "UT",
          survey = "acs1",
          year = x) %>% 
    mutate(year = x) %>% 
    rename(tot_estimate = estimate,
           tot_moe = moe) %>% 
    select(-variable)
})

unemp<- map_df(2012:2017, function(x){
  get_acs(geography = "county",
          variables = c(unemp = "B23025_007"),
          state = "UT",
          survey = "acs1",
          year = x) %>% 
    mutate(year = x) %>% 
    rename(unemp_estimate = estimate,
           unemp_moe = moe) %>% 
    select(-variable)
})

emp <- left_join(emp_tot,unemp)

emp %>% 
  mutate(NAME = str_replace(NAME, ", Utah", ""),
         pct_unemp = unemp_estimate/tot_estimate) %>% 
  ggplot(aes(x = year, y = pct_unemp, color = NAME))+
  geom_line(size= 1)+
  labs(title = "Unemployment Percentage by County per Year", x = "Year", y = "Percentage")+
  scale_y_continuous(labels = percent)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}

median_income <- map_df(2012:2017, function(x){
  get_acs(geography = "county",
          variables = c(hhincome = "B19013_001"),
          state = "UT",
          survey = "acs1",
          year = x) %>% 
    mutate(year = x) 
})

median_income %>% 
  mutate(NAME = str_replace(NAME, ", Utah", "")) %>% 
  ggplot(aes(x = year, y= estimate, color = NAME))+
  geom_line(size =1)+
  labs(title = "Median Household income", x = "Year", y = "Income")+
  scale_y_continuous(labels = dollar)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

family_income <- map_df(2012:2017, function(x){
  get_acs(geography = "county",
          variables = c(famincome = "B19101_001"),
          state = "UT",
          survey = "acs1",
          year = x) %>% 
    mutate(year = x) 
})

family_income %>% 
  mutate(NAME = str_replace(NAME, ", Utah", "")) %>% 
  ggplot(aes(x = year, y= estimate, color = NAME))+
  geom_line(size =1)+
  labs(title = "Family income", x = "Year", y = "Income")+
  scale_y_continuous(labels = dollar)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

family_income_5 <- get_acs(geography = "county",
                           variables = c(famincome = "B19101_001"),
                           state = "UT",
                           survey = "acs5",
                           geometry = TRUE)


family_income_5 %>% 
  mutate(NAME = str_replace(NAME, ", Utah", "")) %>% 
  ggplot(aes(x = reorder(NAME, -estimate),y = estimate)) + 
  geom_errorbar(aes(ymin = estimate - moe, ymax = estimate + moe)) + 
  geom_point(size = 3, color = "red")+
  labs(title = "Family Income per County", x = "County",  y ="Family Income")+
  scale_y_continuous(labels = dollar)



```

```{r echo=FALSE, message=FALSE, warning=FALSE}

family_income_5 %>% 
  ggplot(aes(fill = estimate, color = estimate))+
  geom_sf()+
  scale_fill_viridis_c() +  
  scale_color_viridis_c()+
  labs(title = "Family income across cities in UT")

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

family_income_tracts <- get_acs(geography = "tract",
                                variables = c(famincome = "B19101_001"),
                                state = "UT",
                                survey = "acs5",
                                geometry = TRUE)




family_income_tracts %>% 
  ggplot(aes(fill = estimate, color = estimate))+
  geom_sf()+
  scale_fill_viridis_c() +  
  scale_color_viridis_c()+
  labs(title = "Family income across census tracts in UT")

```

